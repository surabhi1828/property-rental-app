<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard</title>
    <!-- Links to the new dashboard stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/owner_dashboard.css') }}">
</head>
<body>

    <!-- This is the success slider/popup, hidden by default -->
    <div id="toast-notification" class="toast-notification">
        Success! Your property has been updated.
    </div>

    <!-- Assign Tenant Modal -->
    <div id="assign-tenant-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Assign Tenant to Property</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <form id="assign-tenant-form">
                <input type="hidden" id="assign_property_id">
                <div class="form-group">
                    <label for="tenant-select">Select a Tenant:</label>
                    <select id="tenant-select" required>
                        <!-- Tenants will be loaded here by JS -->
                    </select>
                </div>
                <button type="submit" class="btn btn-submit-assign">Assign Tenant</button>
            </form>
        </div>
    </div>
    <!-- End Modal -->

    <div class="dashboard-wrapper">
        
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                FindHome
            </div>
            <div class="sidebar-nav">
                <a class="nav-link active" data-view="dashboard">Dashboard</a>
                <a class="nav-link" data-view="properties">My Properties</a>
                <!-- NEW "My Payments" LINK -->
                <a class="nav-link" data-view="payments">My Payments</a>
                <a class="nav-link" data-view="register">Register Property</a>
                <a class="nav-link" data-view="delete">Delete Property</a>
            </div>
        </nav>

        <!-- Main Content (Navbar + Page) -->
        <main class="main-content">

            <!-- Top Navbar -->
            <header class="top-navbar">
                <h1 id="page-title">Dashboard</h1>
                <div class="user-info">
                    <span>Welcome, {{ session.user_name }}</span>
                    <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
                </div>
            </header>

            <!-- Page Content (Dynamic) -->
            <div class="page-content">

                <!-- 1. Dashboard View (Default) -->
                <section id="dashboard-view" class="content-section active">
                    <div class="dashboard-cards">
                        <div class="card card-green" onclick="showView('properties')">
                            <h3>Total Properties</h3>
                            <p id="total-properties-stat">0</p>
                        </div>
                        <div class="card card-blue" onclick="showView('properties')">
                            <h3>Properties Rented</h3>
                            <p id="rented-properties-stat">0</p>
                        </div>
                        <!-- NEW Card to link to payments -->
                        <div class="card card-blue" onclick="showView('payments')">
                            <h3>Monthly Income</h3>
                            <p id="monthly-income-stat">₹0.00</p>
                        </div>
                    </div>
                </section>

                <!-- 2. My Properties View (Hidden) -->
                <section id="properties-view" class="content-section">
                    <h2>My Registered Properties</h2>
                    <div id="properties-list">
                        <!-- Property cards will be injected here by JS -->
                    </div>
                </section>

                <!-- 3. NEW My Payments View (Hidden) -->
                <section id="payments-view" class="content-section">
                    <h2>Payment Report</h2>
                    <div class="month-picker" id="month-picker-container">
                        <!-- Month buttons will be injected here by JS -->
                    </div>
                    <div class="dashboard-cards">
                        <div class="card card-blue" style="cursor: default;">
                            <h3>Total Income for <span id="payment-report-month">...</span></h3>
                            <p id="total-payment-stat">₹0.00</p>
                        </div>
                    </div>
                    <table class="payments-table">
                        <thead>
                            <tr>
                                <th>Date Paid</th>
                                <th>Tenant</th>
                                <th>Property</th>
                                <th>Month Billed</th>
                                <th>Status</th>
                                <th>Amount</th>
                            </tr>
                        </thead>
                        <tbody id="payments-table-body">
                            <!-- Payment rows injected here -->
                        </tbody>
                    </table>
                </section>

                <!-- 4. Register/Edit Property View (Hidden) -->
                <section id="register-view" class="content-section">
                    <div class="form-container">
                        <h2 id="form-title">Register New Property</h2>
                        <form id="property-form">
                            <input type="hidden" id="property_id" name="property_id">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="address">Address / Home Number</label>
                                    <input type="text" id="address" name="address" required>
                                </div>
                                <div class="form-group">
                                    <label for="city">City</label>
                                    <input type="text" id="city" name="city" required>
                                </div>
                                <div class="form-group">
                                    <label for="monthly_rent">Rent (per month)</label>
                                    <input type="number" id="monthly_rent" name="monthly_rent" required step="0.01">
                                </div>
                                <div class="form-group">
                                    <label for="sq_footage">Sq. Footage (e.g., 1200)</label>
                                    <input type="number" id="sq_footage" name="sq_footage" required>
                                </div>
                                <div class="form-group full-width">
                                    <label for="description">Description</label>
                                    <textarea id="description" name="description" required></textarea>
                                </div>
                                <div class="form-group full-width" id="status-form-group" style="display: none;">
                                    <label for="status">Status</label>
                                    <select id="status" name="status">
                                        <option value="Available">Available</option>
                                        <option value="Rented">Rented</option>
                                        <option value="Maintenance">Maintenance</option>
                                    </select>
                                </div>
                                <div class="form-group full-width">
                                    <button type="submit" class="btn btn-submit">Save Property</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- 5. Delete Property View (Hidden) -->
                <section id="delete-view" class="content-section">
                    <h2>Delete Property</h2>
                    <p>Warning: This action is permanent and cannot be undone.</p>
                    <div id="delete-list">
                        <!-- Simple list of properties to delete -->
                    </div>
                </section>

            </div> <!-- End Page Content -->
        </main> <!-- End Main Content -->
    </div> <!-- End Dashboard Wrapper -->

<script>
    // --- Global Variables ---
    const allNavLinks = document.querySelectorAll('.sidebar-nav .nav-link');
    const allContentSections = document.querySelectorAll('.content-section');
    const pageTitle = document.getElementById('page-title');
    const propertyForm = document.getElementById('property-form');
    const formTitle = document.getElementById('form-title');
    const hiddenPropId = document.getElementById('property_id');
    const statusFieldGroup = document.getElementById('status-form-group');
    const assignTenantModal = document.getElementById('assign-tenant-modal');
    const assignTenantForm = document.getElementById('assign-tenant-form');
    const tenantSelect = document.getElementById('tenant-select');
    const hiddenAssignPropertyId = document.getElementById('assign_property_id');
    const modalTitle = document.getElementById('modal-title');
    // New Payment Variables
    const monthPickerContainer = document.getElementById('month-picker-container');
    const paymentReportMonth = document.getElementById('payment-report-month');
    const totalPaymentStat = document.getElementById('total-payment-stat');
    const paymentsTableBody = document.getElementById('payments-table-body');
    const monthlyIncomeStat = document.getElementById('monthly-income-stat');

    // --- View Switching Logic ---
    function showView(viewId, dataToPass = null) {
        allContentSections.forEach(section => section.classList.remove('active'));
        allNavLinks.forEach(link => link.classList.remove('active'));

        const targetSection = document.getElementById(viewId + '-view');
        if (targetSection) targetSection.classList.add('active');

        const targetLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
        if (targetLink) {
            targetLink.classList.add('active');
            pageTitle.textContent = targetLink.textContent;
        }

        // --- View-Specific Logic ---
        if (viewId === 'dashboard') loadDashboardStats();
        if (viewId === 'properties') loadMyProperties();
        if (viewId === 'payments') loadPaymentReport(); // Load with default (current month)
        if (viewId === 'register') {
            if (dataToPass) setupEditPropertyForm(dataToPass);
            else setupNewPropertyForm();
        }
        if (viewId === 'delete') loadDeleteList();
    }

    allNavLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const viewId = link.getAttribute('data-view');
            showView(viewId);
        });
    });

    // --- Data Loading Functions ---
    document.addEventListener('DOMContentLoaded', () => {
        buildMonthPicker(); // Build the month buttons
        loadDashboardStats(); // Load stats on initial page load
    });

    // 1. Load Dashboard Stats (NOW INCLUDES MONTHLY INCOME)
    async function loadDashboardStats() {
        try {
            // Fetch property counts
            const statsResponse = await fetch('/api/owner/stats'); 
            const statsResult = await statsResponse.json();
            if (statsResult.success) {
                document.getElementById('total-properties-stat').textContent = statsResult.data.total_properties;
                document.getElementById('rented-properties-stat').textContent = statsResult.data.rented_properties;
            }
            
            // Fetch current month income
            const currentMonth = new Date().strftime('%Y-%m');
            const incomeResponse = await fetch(`/api/owner/payments?month=${currentMonth}`);
            const incomeResult = await incomeResponse.json();
            let totalIncome = 0;
            if (incomeResult.success && incomeResult.data) {
                totalIncome = incomeResult.data.reduce((acc, pay) => acc + parseFloat(pay.amount), 0);
            }
            monthlyIncomeStat.textContent = `₹${totalIncome.toFixed(2)}`;

        } catch (err) { console.error('Error loading stats:', err); }
    }

    // 2. Load "My Properties" Cards
    async function loadMyProperties() {
        // (This function is unchanged from your working version)
        const listContainer = document.getElementById('properties-list');
        listContainer.innerHTML = '<p style="text-align:center;">Loading...</p>';
        try {
            const response = await fetch('/api/owner/properties');
            const result = await response.json();
            listContainer.innerHTML = ''; // Clear loading
            if (result.success && result.data.length > 0) {
                result.data.forEach(prop => {
                    const rent = parseFloat(prop.monthly_rent);
                    let statusHTML = '';
                    if (prop.status === 'Available') {
                        statusHTML = `<span class="status-badge status-available">Available</span><button class="btn-assign" onclick="openAssignModal(${prop.property_id}, '${prop.address}')">Assign Tenant</button>`;
                    } else if (prop.status === 'Rented') {
                        statusHTML = `<span class="status-badge status-rented">Rented</span><button class="btn-end-tenancy" onclick="handleEndTenancy(${prop.occupancy_id})">End Tenancy</button>`;
                    } else {
                        statusHTML = `<span class="status-badge status-maintenance">${prop.status}</span>`;
                    }
                    listContainer.innerHTML += `
                        <div class="property-card">
                            <button class="btn-edit" onclick="handleEditClick(${prop.property_id})">Edit</button>
                            <div class="property-card-content">
                                <div class="detail-block">
                                    <h4>Property Details</h4>
                                    <p><strong>Address:</strong> ${prop.address}</p>
                                    <p><strong>City:</strong> ${prop.city}</p>
                                    <p><strong>Rent:</strong> ₹${rent.toFixed(2)} /mo</p>
                                    <p><strong>Sq. Ft:</strong> ${prop.sq_footage} sq.ft.</p>
                                </div>
                                <div class="detail-block">
                                    <h4>Current Tenant</h4>
                                    <p><strong>Name:</strong> ${prop.tenant_name || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${prop.tenant_phone || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${prop.tenant_email || 'N/A'}</p>
                                </div>
                                <div class="detail-block">
                                    <h4>Manage Status</h4>
                                    <p><strong>Description:</strong> ${prop.description}</p>
                                    ${statusHTML}
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else if (result.success) {
                listContainer.innerHTML = '<p style="text-align:center;">You have not registered any properties yet.</p>';
            } else {
                listContainer.innerHTML = `<p style="text-align:center; color: red;">Error: ${result.error}</p>`;
            }
        } catch (err) {
             listContainer.innerHTML = `<p style="text-align:center; color: red;">Error: ${err.message}</p>`;
        }
    }

    // 3. Load "Delete" List
    async function loadDeleteList() {
        // (This function is unchanged from your working version)
        const listContainer = document.getElementById('delete-list');
        listContainer.innerHTML = '<p style="text-align:center;">Loading...</p>';
        try {
            const response = await fetch('/api/owner/properties');
            const result = await response.json();
            listContainer.innerHTML = '';
            if (result.success && result.data.length > 0) {
                result.data.forEach(prop => {
                    listContainer.innerHTML += `
                        <div class="delete-list-item">
                            <p><strong>${prop.address},</strong> ${prop.city} <em>(Status: ${prop.status})</em></p>
                            <button class="btn-delete" onclick="handleDelete(${prop.property_id})">DELETE</button>
                        </div>
                    `;
                });
            } else { listContainer.innerHTML = '<p style="text-align:center;">You have no properties to delete.</p>'; }
        } catch (err) { listContainer.innerHTML = `<p style="text-align:center; color: red;">Error: ${err.message}</p>`; }
    }

    // --- NEW: Payment Report Functions ---
    
    // 4. Build the month-picker buttons
    function buildMonthPicker() {
        monthPickerContainer.innerHTML = ''; // Clear
        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
        const currentYear = new Date().getFullYear();
        const currentMonthNum = new Date().getMonth(); // 0-11
        
        months.forEach((month, index) => {
            const monthYear = `${currentYear}-${('0' + (index + 1)).slice(-2)}`; // e.g., 2025-11
            const isActive = index === currentMonthNum ? 'active' : '';
            monthPickerContainer.innerHTML += `
                <button class="month-btn ${isActive}" data-month-year="${monthYear}">
                    ${month} ${currentYear}
                </button>
            `;
        });

        // Add click listeners to new buttons
        document.querySelectorAll('.month-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const monthYear = btn.getAttribute('data-month-year');
                loadPaymentReport(monthYear);
            });
        });
    }

    // 5. Load the Payment Report
    async function loadPaymentReport(monthYear = null) {
        if (!monthYear) {
            monthYear = new Date().strftime('%Y-%m'); // Default to current month
        }

        // Update active button
        document.querySelectorAll('.month-btn').forEach(btn => {
            btn.classList.toggle('active', btn.getAttribute('data-month-year') === monthYear);
        });
        
        paymentReportMonth.textContent = monthYear;
        paymentsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';
        
        try {
            const response = await fetch(`/api/owner/payments?month=${monthYear}`);
            const result = await response.json();
            paymentsTableBody.innerHTML = '';
            let totalIncome = 0;

            if (result.success && result.data.length > 0) {
                result.data.forEach(pay => {
                    const amount = parseFloat(pay.amount);
                    totalIncome += amount;
                    paymentsTableBody.innerHTML += `
                        <tr>
                            <td>${new Date(pay.payment_date).toLocaleDateString()}</td>
                            <td>${pay.tenant_name}</td>
                            <td>${pay.property_address}</td>
                            <td>${pay.month_year}</td>
                            <td><span class="status-badge status-available">${pay.status}</span></td>
                            <td>₹${amount.toFixed(2)}</td>
                        </tr>
                    `;
                });
            } else if (result.success) {
                paymentsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No payments found for this month.</td></tr>';
            } else {
                paymentsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error: ${result.error}</td></tr>`;
            }
            totalPaymentStat.textContent = `₹${totalIncome.toFixed(2)}`;

        } catch (err) {
            paymentsTableBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color:red;">Error: ${err.message}</td></tr>`;
            totalPaymentStat.textContent = 'Error';
        }
    }

    // --- Form Handling Logic (Unchanged) ---
    function setupNewPropertyForm() {
        propertyForm.reset(); 
        hiddenPropId.value = ''; 
        formTitle.textContent = 'Register New Property';
        statusFieldGroup.style.display = 'none'; 
    }
    async function handleEditClick(propertyId) {
        try {
            const response = await fetch(`/api/owner/property/${propertyId}`); 
            const result = await response.json();
            if (result.success) {
                showView('register', result.data); 
            } else {
                showToast('Error: ' + result.error, true);
            }
        } catch (err) {
            showToast('Error: ' + err.message, true);
        }
    }
    function setupEditPropertyForm(property) {
        propertyForm.reset(); 
        formTitle.textContent = `Edit Property: ${property.address}`;
        statusFieldGroup.style.display = 'block';
        hiddenPropId.value = property.property_id;
        document.getElementById('address').value = property.address;
        document.getElementById('city').value = property.city;
        document.getElementById('monthly_rent').value = property.monthly_rent;
        document.getElementById('sq_footage').value = property.sq_footage;
        document.getElementById('description').value = property.description;
        document.getElementById('status').value = property.status;
    }
    propertyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(propertyForm);
        const data = Object.fromEntries(formData.entries());
        const propertyId = hiddenPropId.value;
        let url = '/api/owner/property';
        let method = 'POST';
        if (propertyId) {
            url = `/api/owner/property/${propertyId}`;
            method = 'PUT';
        } else {
            delete data.status;
        }
        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (result.success) {
                showToast(result.message); 
                showView('properties'); 
            } else {
                showToast('Error: ' + result.error, true);
            }
        } catch (err) {
            showToast('Error: ' + err.message, true);
        }
    });
    async function handleDelete(propertyId) {
        if (!confirm('Are you sure you want to delete this property? This action is permanent.')) return;
        try {
            const response = await fetch(`/api/owner/property/${propertyId}`, { method: 'DELETE' });
            const result = await response.json();
            if (result.success) {
                showToast(result.message);
                loadDeleteList(); 
                loadDashboardStats(); 
            } else {
                showToast('Error: ' + result.error, true);
            }
        } catch (err) {
            showToast('Error: ' + err.message, true);
        }
    }

    // --- Tenancy Management (Unchanged) ---
    function openAssignModal(propertyId, address) {
        modalTitle.textContent = `Assign Tenant to: ${address}`;
        hiddenAssignPropertyId.value = propertyId;
        fetch('/api/owner/all_tenants')
            .then(res => res.json())
            .then(result => {
                tenantSelect.innerHTML = '<option value="" disabled selected>Select a tenant...</option>';
                if (result.success) {
                    result.data.forEach(tenant => {
                        tenantSelect.innerHTML += `<option value="${tenant.tenant_id}">${tenant.name} (${tenant.email})</option>`;
                    });
                }
                assignTenantModal.classList.add('show');
            })
            .catch(err => showToast('Error fetching tenants: ' + err.message, true));
    }
    function closeModal() {
        assignTenantModal.classList.remove('show');
    }
    assignTenantForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const tenantId = tenantSelect.value;
        const propertyId = hiddenAssignPropertyId.value;
        if (!tenantId) {
            showToast('Please select a tenant.', true);
            return;
        }
        try {
            const response = await fetch('/api/owner/assign_tenant', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tenant_id: tenantId, property_id: propertyId })
            });
            const result = await response.json();
            if (result.success) {
                showToast(result.message);
                closeModal();
                loadMyProperties(); 
                loadDashboardStats(); 
            } else {
                showToast('Error: ' + result.error, true);
            }
        } catch (err) {
            showToast('Error: ' + err.message, true);
        }
    });
    async function handleEndTenancy(occupancyId) {
        if (!confirm('Are you sure you want to end this tenancy? The property will become Available.')) return;
        try {
            const response = await fetch('/api/owner/end_tenancy', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ occupancy_id: occupancyId })
            });
            const result = await response.json();
            if (result.success) {
                showToast(result.message);
                loadMyProperties(); 
                loadDashboardStats(); 
            } else {
                showToast('Error: ' + result.error, true);
            }
        } catch (err) {
            showToast('Error: ' + err.message, true);
        }
    }

    // --- Success/Error Popup (Toast) ---
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.style.background = isError ? '#e74c3c' : '#2ecc71'; 
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // Helper for date formatting
    Date.prototype.strftime = function(format) {
        var date = this;
        return format.replace('%Y', date.getFullYear()).replace('%m', ('0' + (date.getMonth() + 1)).slice(-2));
    };
</script>

</body>
</html>