<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenant Dashboard</title>
    <!-- Links to the new dashboard stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tenant_dashboard.css') }}">
</head>
<body>

    <!-- Success/Error Popup -->
    <div id="toast-notification" class="toast-notification"></div>

    <!-- Make Payment Modal -->
    <div id="payment-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="payment-modal-title">Make Payment</h2>
                <span class="close-btn" onclick="closeModal('payment-modal')">&times;</span>
            </div>
            <form id="payment-form">
                <input type="hidden" id="payment-occupancy-id">
                <div class="form-group">
                    <label>Amount Due:</label>
                    <input type="text" id="payment-amount" readonly>
                </div>
                <div class="form-group">
                    <label>For Month:</label>
                    <input type="text" id="payment-month-year" readonly>
                </div>
                <div class="form-group">
                    <label for="payment-method">Payment Method</label>
                    <select id="payment-method" required>
                        <option value="UPI">UPI</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Credit Card">Credit Card</option>
                    </select>
                </div>
                <button type="submit" class="btn btn-blue" style="width: 100%;">Pay Now</button>
            </form>
        </div>
    </div>

    <!-- View Payment History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Payment History</h2>
                <span class="close-btn" onclick="closeModal('history-modal')">&times;</span>
            </div>
            <table class="payment-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Month</th>
                        <th>Method</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="payment-history-table-body">
                    <!-- History rows injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Submit Review Modal -->
    <div id="review-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Submit Review</h2>
                <span class="close-btn" onclick="closeModal('review-modal')">&times;</span>
            </div>
            <form id="review-form">
                <input type="hidden" id="review-property-id">
                <div class="form-group">
                    <label for="review-rating">Rating (1-5)</label>
                    <select id="review-rating" required>
                        <option value="5">5 ⭐ (Excellent)</option>
                        <option value="4">4 ⭐ (Good)</option>
                        <option value="3">3 ⭐ (Average)</option>
                        <option value="2">2 ⭐ (Poor)</option>
                        <option value="1">1 ⭐ (Bad)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="review-comment">Comment</label>
                    <textarea id="review-comment" placeholder="Write your review..."></textarea>
                </div>
                <button type="submit" class="btn btn-blue" style="width: 100%;">Submit Review</button>
            </form>
        </div>
    </div>

    <!-- Main Dashboard Wrapper -->
    <div class="dashboard-wrapper">
        
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                FindHome
            </div>
            <div class="sidebar-nav">
                <a class="nav-link active" data-view="dashboard">Dashboard</a>
                <a class="nav-link" data-view="rentals">My Rentals</a>
                <a class="nav-link" data-view="browse">Browse Properties</a>
            </div>
        </nav>

        <!-- Main Content (Navbar + Page) -->
        <main class="main-content">

            <!-- Top Navbar -->
            <header class="top-navbar">
                <h1 id="page-title">Dashboard</h1>
                <div class="user-info">
                    <span>Welcome, {{ session.user_name }}</span>
                    <a href="{{ url_for('logout') }}" class="btn-logout">Logout</a>
                </div>
            </header>

            <!-- Page Content (Dynamic) -->
            <div class="page-content">

                <!-- 1. Dashboard View (Default) -->
                <section id="dashboard-view" class="content-section active">
                    <div class="dashboard-cards" id="dashboard-cards-container">
                        <!-- Stats injected by JS -->
                    </div>
                </section>

                <!-- 2. My Rentals View (Hidden) -->
                <section id="rentals-view" class="content-section">
                    <h2>My Rentals (Current & Past)</h2>
                    <div id="rentals-list">
                        <!-- Rental cards will be injected here by JS -->
                    </div>
                </section>

                <!-- 3. Browse Properties View (Hidden) -->
                <section id="browse-view" class="content-section">
                    <h2>Browse Available Properties</h2>
                    <div id="browse-list">
                        <!-- Browsable property cards will be injected here by JS -->
                    </div>
                </section>

            </div> <!-- End Page Content -->
        </main> <!-- End Main Content -->
    </div> <!-- End Dashboard Wrapper -->

<script>
    // --- Global Variables ---
    const allNavLinks = document.querySelectorAll('.sidebar-nav .nav-link');
    const allContentSections = document.querySelectorAll('.content-section');
    const pageTitle = document.getElementById('page-title');

    // Modals
    const paymentModal = document.getElementById('payment-modal');
    const historyModal = document.getElementById('history-modal');
    const reviewModal = document.getElementById('review-modal');
    
    // Forms
    const paymentForm = document.getElementById('payment-form');
    const reviewForm = document.getElementById('review-form');

    // --- View Switching Logic ---
    function showView(viewId) {
        allContentSections.forEach(section => section.classList.remove('active'));
        allNavLinks.forEach(link => link.classList.remove('active'));

        const targetSection = document.getElementById(viewId + '-view');
        if (targetSection) targetSection.classList.add('active');

        const targetLink = document.querySelector(`.nav-link[data-view="${viewId}"]`);
        if (targetLink) {
            targetLink.classList.add('active');
            pageTitle.textContent = targetLink.textContent;
        }

        // --- View-Specific Logic ---
        if (viewId === 'dashboard') loadDashboardStats();
        if (viewId === 'rentals') loadMyRentals();
        if (viewId === 'browse') loadBrowsableProperties();
    }

    allNavLinks.forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            const viewId = link.getAttribute('data-view');
            showView(viewId);
        });
    });

    // --- Data Loading Functions ---
    document.addEventListener('DOMContentLoaded', () => {
        loadDashboardStats(); // Load stats on initial page load
    });

    // 1. Load Dashboard Stats
    async function loadDashboardStats() {
        const container = document.getElementById('dashboard-cards-container');
        container.innerHTML = '<p>Loading stats...</p>';
        try {
            const response = await fetch('/api/tenant/rentals'); // We can reuse this
            const result = await response.json();
            if (result.success && result.data.length > 0) {
                const currentRental = result.data.find(r => r.end_date === null);
                
                container.innerHTML = ''; // Clear
                
                if (currentRental) {
                    container.innerHTML += `
                        <div class="card card-green">
                            <h3>Current Rental</h3>
                            <p>${currentRental.address}, ${currentRental.city}</p>
                        </div>
                    `;
                    if (currentRental.rent_due) {
                         container.innerHTML += `
                            <div class="card card-red">
                                <h3>Rent Status</h3>
                                <p>Rent is due for ${new Date().toLocaleString('default', { month: 'long' })}!</p>
                            </div>
                        `;
                    } else {
                         container.innerHTML += `
                            <div class="card card-green">
                                <h3>Rent Status</h3>
                                <p>You are all paid up!</p>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="card">
                            <h3>No Current Rental</h3>
                            <p>You are not currently renting. Click "Browse Properties" to find a new home.</p>
                        </div>
                    `;
                }
            } else {
                container.innerHTML = `<p>Welcome! Click "Browse Properties" to find a home.</p>`;
            }
        } catch(err) {
            container.innerHTML = `<p style="color: red;">Error loading dashboard.</p>`;
        }
    }

    // 2. Load "My Rentals" (Current & Past)
    async function loadMyRentals() {
        const listContainer = document.getElementById('rentals-list');
        listContainer.innerHTML = '<p style="text-align:center;">Loading...</p>';
        try {
            const response = await fetch('/api/tenant/rentals');
            const result = await response.json();
            listContainer.innerHTML = ''; // Clear loading

            if (result.success && result.data.length > 0) {
                result.data.forEach(prop => {
                    const rent = parseFloat(prop.monthly_rent);
                    let statusHTML = '';
                    
                    if (prop.end_date === null) { // Current Rental
                        statusHTML = `<span class="status-badge status-rented">Current Rental</span>`;
                    } else { // Past Rental
                        statusHTML = `<span class="status-badge status-past">Ended: ${new Date(prop.end_date).toLocaleDateString()}</span>`;
                    }

                    listContainer.innerHTML += `
                        <div class="property-card">
                            <div class="property-card-content">
                                <div class="detail-block">
                                    <h4>${prop.address}, ${prop.city}</h4>
                                    <p><strong>Owner:</strong> ${prop.owner_name}</p>
                                    <p><strong>Owner Phone:</strong> ${prop.owner_phone}</p>
                                    <p><strong>Rent:</strong> ₹${rent.toFixed(2)} /mo</p>
                                    <p><strong>Start Date:</strong> ${new Date(prop.start_date).toLocaleDateString()}</p>
                                    ${statusHTML}
                                </div>
                                <div class="detail-block">
                                    <h4>Actions</h4>
                                    ${prop.end_date === null && prop.rent_due ? 
                                        `<button class="btn btn-red" style="width:100%;" onclick="openPaymentModal(${prop.occupancy_id}, ${rent})">
                                            Pay Rent Now
                                        </button>` : ''
                                    }
                                    <button class="btn btn-blue" style="width:100%; margin-top: 10px;" onclick="openHistoryModal(${prop.occupancy_id})">
                                        View Payment History
                                    </button>
                                    <button class="btn btn-grey" style="width:100%; margin-top: 10px;" onclick="openReviewModal(${prop.property_id})">
                                        Write Review
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                listContainer.innerHTML = '<p style="text-align:center;">You have no rental history.</p>';
            }
        } catch (err) {
             listContainer.innerHTML = `<p style="text-align:center; color: red;">Error: ${err.message}</p>`;
        }
    }

    // 3. Load "Browse Properties"
    async function loadBrowsableProperties() {
        const listContainer = document.getElementById('browse-list');
        listContainer.innerHTML = '<p style="text-align:center;">Loading...</p>';
        try {
            const response = await fetch('/api/properties/browse');
            const result = await response.json();
            listContainer.innerHTML = ''; // Clear loading

            if (result.success && result.data.length > 0) {
                const availableProps = result.data.filter(p => p.status === 'Available');
                if (availableProps.length === 0) {
                    listContainer.innerHTML = '<p style="text-align:center;">No properties are available for rent right now.</p>';
                    return;
                }
                
                availableProps.forEach(prop => {
                    const rent = parseFloat(prop.monthly_rent);
                    const rating = prop.avg_rating ? `${parseFloat(prop.avg_rating).toFixed(1)} ⭐` : 'N/A';

                    listContainer.innerHTML += `
                        <div class="property-card">
                            <div class="property-card-content">
                                <div class="detail-block">
                                    <h4>${prop.address}, ${prop.city}</h4>
                                    <p><strong>Owner:</strong> ${prop.owner_name}</p>
                                    <p><strong>Owner Phone:</strong> ${prop.owner_phone}</p>
                                    <p><strong>Rent:</strong> ₹${rent.toFixed(2)} /mo</p>
                                    <p><strong>Rating:</strong> ${rating}</p>
                                </div>
                                <div class="detail-block">
                                    <h4>Manage</h4>
                                    <p>${prop.description}</p>
                                    <span class="status-badge status-available">Available</span>
                                    <button class="btn btn-green" style="width:100%; margin-top: 10px;" onclick="handleRequestToRent(${prop.property_id})">
                                        Request to Rent
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                listContainer.innerHTML = '<p style="text-align:center;">No properties found.</p>';
            }
        } catch (err) {
             listContainer.innerHTML = `<p style="text-align:center; color: red;">Error: ${err.message}</p>`;
        }
    }
    
    // --- Modal & Form Handling ---

    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }

    // --- Payment Logic ---
    function openPaymentModal(occupancyId, amount) {
        const currentMonthYear = new Date().strftime('%Y-%m');
        paymentForm.reset();
        document.getElementById('payment-occupancy-id').value = occupancyId;
        document.getElementById('payment-amount').value = `₹${amount.toFixed(2)}`;
        document.getElementById('payment-month-year').value = currentMonthYear;
        paymentModal.classList.add('show');
    }
    
    paymentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            occupancy_id: document.getElementById('payment-occupancy-id').value,
            amount: parseFloat(document.getElementById('payment-amount').value.replace('₹', '')),
            month_year: document.getElementById('payment-month-year').value,
            method: document.getElementById('payment-method').value
        };

        try {
            const response = await fetch('/api/tenant/make_payment', { // NEW API Route
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message);
                closeModal('payment-modal');
                loadMyRentals();
                loadDashboardStats();
            } else {
                showToast('Error: ' + result.error, true);
            }
        } catch (err) {
            showToast('Error: ' + err.message, true);
        }
    });

    // --- Payment History Logic ---
    async function openHistoryModal(occupancyId) {
        const tableBody = document.getElementById('payment-history-table-body');
        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Loading...</td></tr>';
        historyModal.classList.add('show');
        
        try {
            // We just need the payment data from the main rentals API
            const response = await fetch('/api/tenant/rentals');
            const result = await response.json();
            if (result.success) {
                const rental = result.data.find(r => r.occupancy_id === occupancyId);
                tableBody.innerHTML = ''; // Clear
                if (rental && rental.payments.length > 0) {
                    rental.payments.forEach(p => {
                        tableBody.innerHTML += `
                            <tr>
                                <td>${new Date(p.payment_date).toLocaleDateString()}</td>
                                <td>₹${parseFloat(p.amount).toFixed(2)}</td>
                                <td>${p.month_year}</td>
                                <td>${p.method}</td>
                                <td><span class="status-badge ${p.status === 'Paid' ? 'status-available' : 'status-rented'}">${p.status}</span></td>
                            </tr>
                        `;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No payment history found.</td></tr>';
                }
            }
        } catch(err) {
            tableBody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:red;">${err.message}</td></tr>`;
        }
    }

    // --- Review Logic ---
    function openReviewModal(propertyId) {
        reviewForm.reset();
        document.getElementById('review-property-id').value = propertyId;
        reviewModal.classList.add('show');
    }

    reviewForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            property_id: document.getElementById('review-property-id').value,
            rating: document.getElementById('review-rating').value,
            comment: document.getElementById('review-comment').value
        };

        try {
            const response = await fetch('/api/tenant/review', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            
            if (result.success) {
                showToast(result.message);
                closeModal('review-modal');
            } else {
                showToast('Error: ' + result.error, true);
            }
        } catch (err) {
            showToast('Error: ' + err.message, true);
        }
    });
    
    // --- Request to Rent Logic ---
    async function handleRequestToRent(propertyId) {
        if (!confirm('Are you sure you want to request to rent this property?')) {
            return;
        }
        
        try {
            const response = await fetch('/api/tenant/request-rent', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ property_id: propertyId })
            });
            const result = await response.json();

            if (result.success) {
                showToast(result.message);
                showView('rentals'); // Go to "My Rentals" page
            } else {
                showToast('Error: ' + result.error, true);
            }
        } catch (err) {
            showToast('Error: ' + err.message, true);
        }
    }

    // --- Success/Error Popup (Toast) ---
    function showToast(message, isError = false) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.style.background = isError ? '#e74c3c' : '#2ecc71'; 
        
        toast.classList.add('show');
        
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
    
    // Helper for date formatting
    Date.prototype.strftime = function(format) {
        var date = this;
        return format.replace('%Y', date.getFullYear()).replace('%m', ('0' + (date.getMonth() + 1)).slice(-2));
    };
</script>

</body>
</html>